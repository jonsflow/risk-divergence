# SPY–HYG Divergence on GitHub Pages (with GitHub Actions pulling time‑series)

This repo pattern:
- **GitHub Actions** fetches SPY & HYG time-series from **Yahoo Finance chart JSON** on a schedule
- A small **Node script** extracts just what we need (timestamps + closes) into `/data/*.json`
- A **static webpage** (GitHub Pages) loads `/data/*.json` and computes a simple divergence signal in JavaScript

No API keys, no backend server.

---

## 1) Create the repo + file layout

Create a new GitHub repo and add these files:

```
.
├─ index.html
├─ scripts/
│  └─ build-data.mjs
├─ data/
│  ├─ spy.json        (generated by workflow)
│  └─ hyg.json        (generated by workflow)
└─ .github/
   └─ workflows/
      └─ update-data.yml
```

Commit and push.

---

## 2) Add the GitHub Action workflow

Create: `.github/workflows/update-data.yml`

```yaml
name: Update market data (Yahoo → data/*.json)

on:
  schedule:
    # Weekdays every 30 minutes (cron is UTC)
    - cron: "*/30 * * * 1-5"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: update-data
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Download raw Yahoo chart JSON
        run: |
          mkdir -p .raw data
          curl -L "https://query1.finance.yahoo.com/v8/finance/chart/SPY?range=6mo&interval=1d" -o .raw/spy-raw.json
          curl -L "https://query1.finance.yahoo.com/v8/finance/chart/HYG?range=6mo&interval=1d" -o .raw/hyg-raw.json

      - name: Build compact time series JSON
        run: |
          node scripts/build-data.mjs .raw/spy-raw.json data/spy.json
          node scripts/build-data.mjs .raw/hyg-raw.json data/hyg.json

      - name: Commit changes (if any)
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add data/spy.json data/hyg.json
          git diff --cached --quiet || git commit -m "Update data (Yahoo)"
          git push
```

Notes:
- You can change `range=6mo` and `interval=1d` to match your timeframe.
- Cron is **UTC**. If you want “US market hours,” schedule accordingly.

---

## 3) Add the build script (extract timestamps + closes)

Create: `scripts/build-data.mjs`

```js
import fs from "node:fs";

function die(msg) {
  console.error(msg);
  process.exit(1);
}

const [,, inPath, outPath] = process.argv;
if (!inPath || !outPath) die("Usage: node scripts/build-data.mjs <inputRawYahoo.json> <outputCompact.json>");

const raw = JSON.parse(fs.readFileSync(inPath, "utf8"));

// Yahoo chart response shape:
// chart.result[0].timestamp[] (epoch seconds)
// chart.result[0].indicators.quote[0].close[] (numbers; may include nulls)
const result = raw?.chart?.result?.[0];
if (!result) die("Unexpected Yahoo response: missing chart.result[0]");

const ts = result.timestamp || [];
const closes = result?.indicators?.quote?.[0]?.close || [];
if (!Array.isArray(ts) || !Array.isArray(closes)) die("Unexpected Yahoo response: missing timestamp/close arrays");

const points = [];
for (let i = 0; i < Math.min(ts.length, closes.length); i++) {
  const t = ts[i];
  const c = closes[i];
  if (t == null || c == null) continue;     // drop null close days
  points.push([t, c]);
}

const symbol = result.meta?.symbol ?? "UNKNOWN";
const interval = result.meta?.dataGranularity ?? "UNKNOWN";
const updated = Math.floor(Date.now() / 1000);

const compact = {
  symbol,
  interval,
  updated,     // when the workflow built this file (epoch seconds)
  points       // [[epochSec, close], ...]
};

fs.writeFileSync(outPath, JSON.stringify(compact));
console.log(`Wrote ${outPath}: ${symbol} (${points.length} points, ${interval})`);
```

This keeps `data/*.json` small and stable.

---

## 4) Add the static webpage (divergence computation in JavaScript)

Create: `index.html`

```html
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPY–HYG Divergence</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 28px; background:#0f0f10; color:#e9e9ea; }
    .card { max-width: 720px; background:#17181b; padding: 18px 18px 14px; border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { margin: 0 0 8px; font-size: 20px; }
    .muted { color:#a7a7ad; font-size: 13px; }
    .row { display:flex; gap:14px; flex-wrap:wrap; margin-top: 12px; }
    .pill { background:#22242a; padding: 10px 12px; border-radius: 12px; min-width: 200px; }
    .signal { font-size: 18px; margin-top: 12px; }
    code { color:#d5d5ff; }
  </style>
</head>
<body>
  <div class="card">
    <h1>SPY ↔ HYG Divergence</h1>
    <div class="muted" id="meta">Loading data…</div>

    <div class="row">
      <div class="pill"><div class="muted">Lookback</div><div><code id="lookback"></code></div></div>
      <div class="pill"><div class="muted">SPY slope</div><div><code id="spySlope"></code></div></div>
      <div class="pill"><div class="muted">HYG slope</div><div><code id="hygSlope"></code></div></div>
    </div>

    <div class="signal" id="signal"></div>
    <div class="muted" style="margin-top:10px">
      Divergence definition here: compute slope of <b>daily returns</b> over the lookback window.
      Divergence = SPY slope &gt; 0 while HYG slope &lt; 0.
    </div>
  </div>

<script>
  // ----- TUNABLES -----
  const LOOKBACK = 20;   // number of return points used for slope
  const RETURN_LAG = 1;  // 1 = daily returns; set 5 for 5-day returns

  // ----- HELPERS -----
  function toIso(epochSec) {
    return new Date(epochSec * 1000).toISOString().replace("T", " ").slice(0, 16) + "Z";
  }

  function calcReturns(points, lag) {
    // points = [[t, close], ...]
    const closes = points.map(p => p[1]);
    const rets = [];
    for (let i = lag; i < closes.length; i++) {
      const prev = closes[i - lag];
      const cur = closes[i];
      rets.push((cur - prev) / prev);
    }
    return rets;
  }

  function slope(y) {
    // simple least-squares slope over equally spaced x = 0..n-1
    const n = y.length;
    if (n < 2) return NaN;
    let sx=0, sy=0, sxy=0, sxx=0;
    for (let i = 0; i < n; i++) {
      sx += i; sy += y[i]; sxy += i * y[i]; sxx += i * i;
    }
    const denom = (n * sxx - sx * sx);
    return denom === 0 ? NaN : (n * sxy - sx * sy) / denom;
  }

  async function loadJson(path) {
    const r = await fetch(path, { cache: "no-store" });
    if (!r.ok) throw new Error(`Fetch failed ${r.status} for ${path}`);
    return r.json();
  }

  function last(arr, n) {
    return arr.slice(Math.max(0, arr.length - n));
  }

  function fmt(x) {
    return Number.isFinite(x) ? x.toFixed(6) : "NaN";
  }

  // ----- MAIN -----
  (async function main() {
    const [spy, hyg] = await Promise.all([
      loadJson("./data/spy.json"),
      loadJson("./data/hyg.json"),
    ]);

    const spyR = calcReturns(spy.points, RETURN_LAG);
    const hygR = calcReturns(hyg.points, RETURN_LAG);

    const spySlope = slope(last(spyR, LOOKBACK));
    const hygSlope = slope(last(hygR, LOOKBACK));

    document.getElementById("lookback").textContent = `${LOOKBACK} returns (lag=${RETURN_LAG})`;
    document.getElementById("spySlope").textContent = fmt(spySlope);
    document.getElementById("hygSlope").textContent = fmt(hygSlope);

    const updated = Math.min(spy.updated ?? Infinity, hyg.updated ?? Infinity);
    const rangeInfo = `SPY pts: ${spy.points.length} | HYG pts: ${hyg.points.length}`;
    document.getElementById("meta").textContent =
      `Data updated: ${Number.isFinite(updated) ? toIso(updated) : "unknown"} · ${rangeInfo}`;

    let signal = "⚖️ No clear divergence";
    if (spySlope > 0 && hygSlope < 0) signal = "⚠️ Bearish divergence: SPY strengthening while HYG weakens";
    if (spySlope > 0 && hygSlope > 0) signal = "✅ Risk-on confirmation: SPY and HYG aligned (both strengthening)";
    if (spySlope < 0 && hygSlope > 0) signal = "⚠️ Opposite divergence: SPY weakening while HYG strengthens";

    document.getElementById("signal").textContent = signal;
  })().catch(err => {
    document.getElementById("meta").textContent = "Error loading data.";
    document.getElementById("signal").textContent = String(err);
  });
</script>
</body>
</html>
```

---

## 5) Enable GitHub Pages

In the repo:
- **Settings → Pages**
- Source: **Deploy from a branch**
- Branch: `main`
- Folder: `/ (root)`

After a minute, your site will be available at:
`https://<your-username>.github.io/<repo-name>/`

---

## 6) Trigger the first data pull

- Go to **Actions** tab → “Update market data (Yahoo → data/*.json)”
- Click **Run workflow**
- After it finishes, you should see `data/spy.json` and `data/hyg.json` committed.

Refresh your GitHub Pages URL.

---

## Practical limits / gotchas (quick)

- **Cron is UTC** (your “every 30 minutes weekdays” is UTC). Adjust if you care about market hours.
- Avoid committing too frequently (it bloats history and can queue Pages builds).
- Yahoo endpoints can change over time; if it breaks, the workflow logs will show it.

---

## Optional: avoid repo-history bloat
Instead of committing JSON into `main`, you can:
- build JSON in Actions
- publish to the `gh-pages` branch as an artifact of the deploy step  
…but that’s a slightly bigger setup. The above is the minimal version.

---
