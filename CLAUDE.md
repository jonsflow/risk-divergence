# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

SPY–HYG Divergence is a static GitHub Pages site that computes a simple divergence signal between SPY (S&P 500 ETF) and HYG (high-yield corporate bond ETF) entirely in the browser. The project uses GitHub Actions to fetch daily CSV data from Stooq on a schedule, and the webpage performs client-side CSV parsing and divergence calculations using vanilla JavaScript.

**Key insight**: This is a fully static site. GitHub Pages serves both the HTML and the CSV files as static assets. The browser fetches and processes the CSV files entirely client-side - no backend server required.

## Architecture

### Data Pipeline
1. **GitHub Actions workflow** (`.github/workflows/update-data.yml`) runs on a schedule (every 30 minutes on weekdays, UTC)
2. Downloads CSV files from Stooq for SPY and HYG using direct `curl` commands
3. Commits the CSV files to `data/spy.csv` and `data/hyg.csv` if changes are detected
4. GitHub Pages serves everything as static content (HTML + CSS + JS + CSV files)

### Client-Side Processing
1. `index.html` contains all HTML, CSS, and JavaScript in a single file
2. On page load, fetches `data/spy.csv` and `data/hyg.csv` via `fetch()` with `cache: "no-store"`
3. Parses CSV client-side (no dependencies, pure JavaScript)
4. Computes daily returns and slopes using least-squares regression
5. Displays divergence signal based on slope comparison

### Signal Logic
- **Bearish divergence**: SPY slope > 0 while HYG slope < 0 (equities strengthening while bonds weaken)
- **Risk-on confirmation**: Both slopes > 0 (aligned strengthening)
- **Opposite divergence**: SPY slope < 0 while HYG slope > 0

Default parameters (configurable in `index.html`):
- `LOOKBACK = 20`: Number of return points used for slope calculation
- `RETURN_LAG = 1`: Lag for computing returns (1 = daily returns)

## Development Commands

### Triggering Data Updates
The workflow can be manually triggered via GitHub Actions UI:
```bash
# Navigate to: Actions → "Update market data (Stooq → data/*.csv)" → Run workflow
```

Or commit and push changes to trigger a new deployment:
```bash
git add .
git commit -m "Update site"
git push
```

### Testing Locally
Since this is a static site that fetches CSV files, you need a local server to avoid CORS issues with the `file://` protocol:

```bash
# Using Python 3
python3 -m http.server 8000

# Using Node.js
npx http-server -p 8000

# Using PHP
php -S localhost:8000
```

Then visit `http://localhost:8000` in your browser.

**Note**: Local testing requires the `data/` directory with CSV files to exist. You can either:
1. Manually download sample CSV files from Stooq
2. Wait for the GitHub Actions workflow to run and pull the repo

### Workflow Testing
To test workflow changes without waiting for the schedule:
1. Make changes to `.github/workflows/update-data.yml`
2. Push to `main`
3. Go to Actions tab and manually trigger "Update market data"

## File Structure

```
.
├── index.html                          # Single-file static site (HTML + CSS + JS)
├── data/                               # Generated by GitHub Actions
│   ├── spy.csv                         # SPY daily OHLCV data from Stooq
│   └── hyg.csv                         # HYG daily OHLCV data from Stooq
├── .github/
│   └── workflows/
│       └── update-data.yml             # Scheduled data fetching workflow
└── github-pages-spy-hyg-divergence-setup.md  # Setup documentation
```

## Important Technical Details

### Data Source
- **Current**: Stooq CSV endpoints (`https://stooq.com/q/d/l/?s=SPY.US&i=d`)
- **Note**: The setup doc (`github-pages-spy-hyg-divergence-setup.md`) references Yahoo Finance JSON, but the actual implementation uses Stooq CSV. This is simpler (no Node.js processing script needed).

### CSV Format Expected
```
Date,Open,High,Low,Close,Volume
2024-01-01,450.00,452.00,449.00,451.50,1000000
```

The parser (`loadCsvPoints()` in `index.html:71`) extracts only Date and Close columns.

### Client-Side Calculations
- **Returns calculation** (`calcReturns()` at `index.html:47`): Computes percentage returns with configurable lag
- **Slope calculation** (`slope()` at `index.html:59`): Simple least-squares regression over equally spaced x-coordinates
- **Last N points** (`last()` at `index.html:90`): Extracts the most recent N data points for windowed analysis

### GitHub Actions Concurrency
The workflow uses `concurrency.cancel-in-progress: false` to prevent overlapping runs from stomping on each other during git operations. This is critical for data integrity.

## Modifying the Divergence Logic

To change the signal parameters, edit the tunables at the top of the `<script>` section in `index.html:38-40`:

```javascript
const LOOKBACK = 20;   // number of return points used for slope
const RETURN_LAG = 1;  // 1 = daily returns; set 5 for 5-day returns
```

To change the signal messages, edit the conditionals in `index.html:122-125`.

## GitHub Pages Setup

Required settings (Settings → Pages):
- Source: Deploy from a branch
- Branch: `main`
- Folder: `/ (root)`

The site will be available at `https://<username>.github.io/<repo-name>/`

## Common Gotchas

1. **CORS errors during local development**: Must use a local HTTP server, not `file://` protocol. On GitHub Pages this is not an issue.
2. **Stale data in browser**: CSV files are fetched with `cache: "no-store"`, but browser DevTools may override this
3. **Workflow schedule is UTC**: The cron `*/30 * * * 1-5` runs every 30 min on weekdays in UTC time, not local time
4. **CSV format changes**: If Stooq changes their CSV format, the parser in `loadCsvPoints()` will need updating
5. **Data not appearing**: Ensure the workflow has run at least once (check Actions tab for green checkmark)
