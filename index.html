<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPYâ€“HYG Divergence</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 28px; background:#0f0f10; color:#e9e9ea; }
    .card { max-width: 720px; background:#17181b; padding: 18px 18px 14px; border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { margin: 0 0 8px; font-size: 20px; }
    .muted { color:#a7a7ad; font-size: 13px; }
    .row { display:flex; gap:14px; flex-wrap:wrap; margin-top: 12px; }
    .pill { background:#22242a; padding: 10px 12px; border-radius: 12px; min-width: 200px; }
    .signal { font-size: 18px; margin-top: 12px; }
    code { color:#d5d5ff; }
  </style>
  <meta name="description" content="Simple SPYâ€“HYG divergence signal computed client-side from JSON time-series built by GitHub Actions." />
</head>
<body>
  <div class="card">
    <h1>SPY â†” HYG Divergence</h1>
    <div class="muted" id="meta">Loading dataâ€¦</div>

    <div class="row">
      <div class="pill"><div class="muted">Lookback</div><div><code id="lookback"></code></div></div>
      <div class="pill"><div class="muted">SPY Trend</div><div><code id="spySlope"></code></div></div>
      <div class="pill"><div class="muted">HYG Trend</div><div><code id="hygSlope"></code></div></div>
    </div>

    <div class="signal" id="signal"></div>
    <div class="muted" style="margin-top:10px">
      Divergence definition: Identifies when SPY makes <b>higher highs</b> while HYG makes <b>lower lows</b> (or vice versa).
      Swing points detected using a 5-day window.
    </div>
  </div>

  <div class="card" style="margin-top:18px">
    <h2 style="font-size:16px;margin:0 0 12px">SPY Price Chart</h2>
    <div id="chartSpy" style="width:100%;height:200px"></div>
  </div>

  <div class="card" style="margin-top:18px">
    <h2 style="font-size:16px;margin:0 0 12px">HYG Price Chart</h2>
    <div id="chartHyg" style="width:100%;height:200px"></div>
  </div>

  <div class="card" style="margin-top:18px">
    <h2 style="font-size:16px;margin:0 0 12px">SPY/HYG Ratio</h2>
    <div id="chartRatio" style="width:100%;height:200px"></div>
  </div>

<script>
  // ----- TUNABLES -----
  const LOOKBACK_DAYS = 90;   // number of days to analyze for divergence (configurable)
  const SWING_WINDOW = 5;     // days on each side to identify swing highs/lows

  // ----- HELPERS -----
  function toIso(epochSec) {
    return new Date(epochSec * 1000).toISOString().replace("T", " ").slice(0, 10);
  }

  function last(arr, n) {
    return arr.slice(Math.max(0, arr.length - n));
  }

  // Find swing highs: points higher than neighbors within window
  function findSwingHighs(points, window = 5) {
    const swings = [];
    for (let i = window; i < points.length - window; i++) {
      const price = points[i][1];
      let isHigh = true;
      for (let j = i - window; j <= i + window; j++) {
        if (j !== i && points[j][1] >= price) {
          isHigh = false;
          break;
        }
      }
      if (isHigh) swings.push({ idx: i, time: points[i][0], price });
    }
    return swings;
  }

  // Find swing lows: points lower than neighbors within window
  function findSwingLows(points, window = 5) {
    const swings = [];
    for (let i = window; i < points.length - window; i++) {
      const price = points[i][1];
      let isLow = true;
      for (let j = i - window; j <= i + window; j++) {
        if (j !== i && points[j][1] <= price) {
          isLow = false;
          break;
        }
      }
      if (isLow) swings.push({ idx: i, time: points[i][0], price });
    }
    return swings;
  }

  // Detect higher highs: are recent swing highs increasing?
  function hasHigherHighs(swingHighs) {
    if (swingHighs.length < 2) return false;
    const recent = swingHighs.slice(-3); // look at last 3 swing highs
    if (recent.length < 2) return false;
    // Check if generally trending up
    let increasing = 0;
    for (let i = 1; i < recent.length; i++) {
      if (recent[i].price > recent[i-1].price) increasing++;
    }
    return increasing >= recent.length - 1; // at least one higher high
  }

  // Detect lower lows: are recent swing lows decreasing?
  function hasLowerLows(swingLows) {
    if (swingLows.length < 2) return false;
    const recent = swingLows.slice(-3); // look at last 3 swing lows
    if (recent.length < 2) return false;
    // Check if generally trending down
    let decreasing = 0;
    for (let i = 1; i < recent.length; i++) {
      if (recent[i].price < recent[i-1].price) decreasing++;
    }
    return decreasing >= recent.length - 1; // at least one lower low
  }

  async function loadCsvPoints(path) {
    const r = await fetch(path, { cache: "no-store" });
    if (!r.ok) throw new Error(`Fetch failed ${r.status} for ${path}`);
    const text = await r.text();
    const lines = text.trim().split(/\r?\n/);
    const header = lines.shift(); // Date,Open,High,Low,Close,Volume
    const points = [];
    for (const line of lines) {
      const [date, , , , close] = line.split(",");
      if (!date || !close || date === "Date" || close === "Close") continue;
      const t = Math.floor(new Date(date + "T00:00:00Z").getTime() / 1000);
      const c = Number(close);
      if (!Number.isFinite(t) || !Number.isFinite(c)) continue;
      points.push([t, c]);
    }
    points.sort((a, b) => a[0] - b[0]);
    return points;
  }

  function fmt(x) {
    return Number.isFinite(x) ? x.toFixed(2) : "N/A";
  }

  // Simple SVG line chart renderer
  function renderChart(containerId, points, color = "#4a9eff", label = "") {
    const container = document.getElementById(containerId);
    if (!container) return;

    const width = container.clientWidth;
    const height = container.clientHeight;
    const padding = { top: 10, right: 10, bottom: 25, left: 50 };
    const chartWidth = width - padding.left - padding.right;
    const chartHeight = height - padding.top - padding.bottom;

    if (points.length === 0) {
      container.innerHTML = '<div style="padding:20px;color:#666">No data</div>';
      return;
    }

    // Extract values
    const times = points.map(p => p[0]);
    const values = points.map(p => p[1]);
    const minVal = Math.min(...values);
    const maxVal = Math.max(...values);
    const minTime = times[0];
    const maxTime = times[times.length - 1];

    // Scale functions
    const xScale = (t) => padding.left + ((t - minTime) / (maxTime - minTime)) * chartWidth;
    const yScale = (v) => padding.top + chartHeight - ((v - minVal) / (maxVal - minVal)) * chartHeight;

    // Build path
    let path = points.map((p, i) => {
      const x = xScale(p[0]);
      const y = yScale(p[1]);
      return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
    }).join(' ');

    // Format dates for axis
    const startDate = new Date(minTime * 1000).toISOString().slice(0, 10);
    const endDate = new Date(maxTime * 1000).toISOString().slice(0, 10);

    container.innerHTML = `
      <svg width="${width}" height="${height}" style="display:block">
        <!-- Grid lines -->
        <line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${height - padding.bottom}"
              stroke="#333" stroke-width="1"/>
        <line x1="${padding.left}" y1="${height - padding.bottom}" x2="${width - padding.right}" y2="${height - padding.bottom}"
              stroke="#333" stroke-width="1"/>

        <!-- Chart line -->
        <path d="${path}" fill="none" stroke="${color}" stroke-width="2" />

        <!-- Y-axis labels -->
        <text x="${padding.left - 5}" y="${padding.top + 5}" text-anchor="end" fill="#a7a7ad" font-size="11">${maxVal.toFixed(2)}</text>
        <text x="${padding.left - 5}" y="${height - padding.bottom + 5}" text-anchor="end" fill="#a7a7ad" font-size="11">${minVal.toFixed(2)}</text>

        <!-- X-axis labels -->
        <text x="${padding.left}" y="${height - padding.bottom + 18}" text-anchor="start" fill="#a7a7ad" font-size="11">${startDate}</text>
        <text x="${width - padding.right}" y="${height - padding.bottom + 18}" text-anchor="end" fill="#a7a7ad" font-size="11">${endDate}</text>
      </svg>
    `;
  }

  // ----- MAIN -----
  (async function main() {
    const [spyPts, hygPts] = await Promise.all([
      loadCsvPoints("./data/spy.csv"),
      loadCsvPoints("./data/hyg.csv"),
    ]);

    // Get recent data for analysis
    const spyRecent = last(spyPts, LOOKBACK_DAYS);
    const hygRecent = last(hygPts, LOOKBACK_DAYS);

    // Find swing points
    const spyHighs = findSwingHighs(spyRecent, SWING_WINDOW);
    const spyLows = findSwingLows(spyRecent, SWING_WINDOW);
    const hygHighs = findSwingHighs(hygRecent, SWING_WINDOW);
    const hygLows = findSwingLows(hygRecent, SWING_WINDOW);

    // Detect trends
    const spyMakingHigherHighs = hasHigherHighs(spyHighs);
    const spyMakingLowerLows = hasLowerLows(spyLows);
    const hygMakingHigherHighs = hasHigherHighs(hygHighs);
    const hygMakingLowerLows = hasLowerLows(hygLows);

    // Update display
    document.getElementById("lookback").textContent = `${LOOKBACK_DAYS} days`;
    document.getElementById("spySlope").textContent = spyMakingHigherHighs ? "Higher Highs â†—" : (spyMakingLowerLows ? "Lower Lows â†˜" : "Sideways â†”");
    document.getElementById("hygSlope").textContent = hygMakingHigherHighs ? "Higher Highs â†—" : (hygMakingLowerLows ? "Lower Lows â†˜" : "Sideways â†”");

    const lastSpy = spyPts.length ? spyPts[spyPts.length - 1][0] : NaN;
    const lastHyg = hygPts.length ? hygPts[hygPts.length - 1][0] : NaN;
    const lastTs = Math.max(lastSpy || -Infinity, lastHyg || -Infinity);
    const rangeInfo = `SPY pts: ${spyPts.length} | HYG pts: ${hygPts.length}`;
    document.getElementById("meta").textContent =
      `Last date: ${Number.isFinite(lastTs) ? toIso(lastTs) : "unknown"} Â· ${rangeInfo}`;

    // Determine divergence signal
    let message = "âš–ï¸ No clear divergence";

    if (spyMakingHigherHighs && hygMakingLowerLows) {
      message = "âš ï¸ BEARISH DIVERGENCE: SPY making higher highs while HYG making lower lows (equities strong, credit weak)";
    } else if (spyMakingLowerLows && hygMakingHigherHighs) {
      message = "âš ï¸ OPPOSITE DIVERGENCE: SPY making lower lows while HYG making higher highs (unusual pattern)";
    } else if (spyMakingHigherHighs && hygMakingHigherHighs) {
      message = "âœ… RISK-ON: Both SPY and HYG making higher highs (healthy bull market)";
    } else if (spyMakingLowerLows && hygMakingLowerLows) {
      message = "ðŸ”´ RISK-OFF: Both SPY and HYG making lower lows (bear market)";
    }

    document.getElementById("signal").textContent = message;

    // Render charts (last 180 days for better visibility)
    const chartDays = 180;
    const spyChart = last(spyPts, chartDays);
    const hygChart = last(hygPts, chartDays);

    renderChart("chartSpy", spyChart, "#4a9eff", "SPY");
    renderChart("chartHyg", hygChart, "#ff6b6b", "HYG");

    // Calculate and render ratio chart
    // Align timestamps and calculate SPY/HYG ratio
    const ratioPoints = [];
    const spyMap = new Map(spyChart.map(p => [p[0], p[1]]));
    const hygMap = new Map(hygChart.map(p => [p[0], p[1]]));

    for (const [time, spyPrice] of spyMap) {
      const hygPrice = hygMap.get(time);
      if (hygPrice && hygPrice !== 0) {
        ratioPoints.push([time, spyPrice / hygPrice]);
      }
    }

    renderChart("chartRatio", ratioPoints, "#a78bfa", "SPY/HYG");
  })().catch(err => {
    document.getElementById("meta").textContent = "Error loading data.";
    document.getElementById("signal").textContent = String(err);
  });
</script>
</body>
</html>
